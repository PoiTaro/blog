<!DOCTYPE html>
<html lang="ja">
<head>
    <meta name="robots" content="noindex, nofollow">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>高機能Markdownエディタ</title>
    
    <!-- Tailwind CSS with Typography Plugin -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Marked.js for Markdown Preview -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script>
        // ライトモードのみ
        document.documentElement.classList.remove('dark');

        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans JP', 'sans-serif'],
                    },
                    colors: {
                        'primary': {
                            '50': '#fffbeb',
                            '100': '#fef3c7',
                            '200': '#fde68a',
                            '300': '#fcd34d',
                            '400': '#fbbf24',
                            '500': '#f59e0b',
                            '600': '#d97706',
                            '700': '#b45309',
                            '800': '#92400e',
                            '900': '#78350f',
                            '950': '#451a03',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Editor-specific styles */
        input[type="text"], input[type="date"], textarea { 
            width: 100%; 
            padding: 0.75rem; 
            border-radius: 0.5rem; 
            font-family: 'Noto Sans JP', sans-serif; 
            font-size: 16px; 
            background-color: #F5F3FF; 
            border: 2px solid #8B5CF6; 
            transition: box-shadow 0.2s, border-color 0.2s;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        input[type="text"]:focus, input[type="date"]:focus, textarea:focus { 
            outline: none; 
            border-color: #6D28D9; 
            box-shadow: 0 0 0 4px rgba(167, 139, 250, 0.5); 
        }
        
        /* Mobile-optimized textarea */
        textarea#markdown-input { 
            min-height: 300px; 
            resize: vertical; 
            font-family: 'Courier New', 'Monaco', monospace; 
            font-size: 14px; 
            line-height: 1.5;
        }
        
        @media (min-width: 768px) {
            textarea#markdown-input { 
                min-height: 400px; 
                font-size: 16px; 
            }
        }
        
        input[type="color"] { 
            width: 50px; 
            height: 40px; 
            padding: 0; 
            border: 2px solid #8B5CF6; 
            border-radius: 0.5rem;
            cursor: pointer; 
        }
        
        /* Enhanced button styles */
        .blog-btn { 
            font-family: 'Inter', sans-serif; 
            border: none; 
            border-radius: 0.5rem; 
            padding: 0.75rem 1rem; 
            font-size: 0.875rem; 
            cursor: pointer; 
            transition: all 0.2s ease-in-out;
            touch-action: manipulation;
            user-select: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-height: 44px; /* Touch target size */
        }
        
        .blog-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .blog-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .blog-btn.active { 
            background-color: #f59e0b !important; 
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
        }
        
        .file-ops-btn { 
            padding: 0.75rem 1.5rem; 
            font-size: 1rem; 
            border-radius: 50px; 
            min-width: 120px;
        }
        
        /* Mobile-optimized toolbar */
        .toolbar-group {
            margin-bottom: 0.5rem;
        }
        
        .toolbar-label {
            font-size: 0.75rem;
            color: #6b7280;
            margin-right: 0.5rem;
            font-weight: 600;
            white-space: nowrap;
        }
        
        @media (max-width: 640px) {
            .toolbar-label {
                display: none;
            }
            
            .blog-btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
                min-height: 40px;
            }
            
            .file-ops-btn {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
                min-width: 100px;
            }
        }
        
        /* Enhanced preview area */
        .markdown-preview { 
            background-color: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(8px); 
            padding: 1.5rem; 
            border-radius: 0.75rem; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            min-height: 200px; 
            overflow-wrap: break-word; 
            border: 2px solid #f59e0b;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .form-group { 
            margin-bottom: 1rem; 
        }
        
        .form-group label { 
            display: block; 
            font-weight: 600; 
            margin-bottom: 0.5rem; 
            font-family: 'Noto Sans JP', sans-serif; 
            font-size: 0.875rem;
        }

        /* Typography-Plugin-Styles */
        .prose h2 {
            border-bottom: 2px solid #fde68a;
            padding-bottom: 0.5rem;
        }
        .dark .prose h2 {
            border-bottom-color: #78350f;
        }
        .prose blockquote {
            font-style: normal;
            border-left-width: 4px;
        }
        
        /* Tab navigation improvements */
        .tab-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 50;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid #e5e7eb;
        }
        
        .tab-button {
            padding: 1rem 1.5rem;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s ease;
            border-radius: 0;
            min-height: 52px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @media (max-width: 640px) {
            .tab-button {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
                min-height: 48px;
            }
        }
        
        /* Floating action button for mobile */
        .fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #f59e0b;
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            z-index: 40;
            transition: all 0.3s ease;
        }
        
        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(245, 158, 11, 0.5);
        }
        
        /* Search and replace mobile optimization */
        .search-replace-container {
            background: #f9fafb;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        @media (max-width: 640px) {
            .search-replace-container .flex {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .search-replace-container input {
                margin-bottom: 0.5rem;
            }
        }
        
        /* Content spacing for tab view */
        .tab-content {
            padding-top: 4rem;
            padding-bottom: 2rem;
        }
        
        @media (max-width: 640px) {
            .tab-content {
                padding-top: 3.5rem;
            }
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Loading indicator */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        
        /* Touch feedback */
        .blog-btn:active,
        .tab-button:active {
            background-color: rgba(0, 0, 0, 0.1) !important;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 60;
            opacity: 0;
            pointer-events: none;
            transition: opacity .2s ease;
        }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal-container {
            width: calc(100% - 2rem);
            max-width: 560px;
            background: white;
            color: #111827;
            border-radius: 0.75rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            overflow: hidden;
            transform: translateY(10px) scale(.98);
            transition: transform .2s ease;
        }
        .dark .modal-container { background: #1f2937; color: #e5e7eb; }
        .modal-overlay.show .modal-container { transform: translateY(0) scale(1); }
        .modal-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 1rem 1.25rem; border-bottom: 1px solid #e5e7eb;
            background: linear-gradient(90deg, #8b5cf6, #f59e0b);
            color: white;
        }
        .modal-body { padding: 1rem 1.25rem; }
        .modal-footer { padding: 1rem 1.25rem; border-top: 1px solid #e5e7eb; display:flex; gap:.5rem; justify-content:flex-end; }
        .modal-close { background: transparent; border:none; color: white; font-size: 1.25rem; cursor: pointer; }
        .modal-input { width: 100%; padding: .75rem 1rem; border: 2px solid #e5e7eb; border-radius: .5rem; font-size: .95rem; }
        .dark .modal-input { background: #374151; border-color:#4b5563; color:#e5e7eb; }
        .modal-label { display:block; font-weight:600; margin-bottom:.4rem; }
        .modal-actions .blog-btn { min-width: 96px; }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 font-sans text-gray-700 dark:text-gray-300 antialiased">

    <main class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Mobile-optimized layout toggle -->
        <div id="layout-toggle" class="mb-6 flex justify-center gap-3 sticky top-4 z-40" style="margin-top:2rem;">
            <button id="btn-split-view" class="blog-btn bg-primary-500 hover:bg-primary-600 text-white text-sm md:text-base px-4 py-3 hidden md:flex">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 002-2M9 7a2 2 0 00-2 2v6a2 2 0 002 2h6a2 2 0 002-2V9a2 2 0 00-2-2H9z"></path>
                </svg>
                分割ビュー
            </button>
            <button id="btn-tab-view" class="blog-btn bg-gray-600 hover:bg-gray-700 text-white text-sm md:text-base px-4 py-3 active">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                </svg>
                タブビュー
            </button>
        </div>

        <!-- Tab View -->
        <div id="tab-view">
            <div class="tab-nav flex border-b bg-white dark:bg-gray-900">
                <button id="tab-editor" class="tab-button flex-1 bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-white border-r">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                    <span class="hidden sm:inline">エディタ</span>
                    <span class="sm:hidden">編集</span>
                </button>
                <button id="tab-preview" class="tab-button flex-1 bg-white dark:bg-gray-900 text-gray-500 dark:text-gray-400">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                    <span class="hidden sm:inline">プレビュー</span>
                    <span class="sm:hidden">表示</span>
                </button>
            </div>
            <div id="tab-editor-content" class="tab-content p-4">
            </div>
            <div id="tab-preview-content" class="tab-content p-4 hidden">
            </div>
        </div>

        <!-- Split View -->
        <div id="split-view" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-8">
            <section class="space-y-6">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                    <div class="bg-gradient-to-r from-purple-500 to-pink-500 p-4">
                        <h2 class="text-xl font-bold text-white flex items-center">
                            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            記事情報 (Frontmatter)
                        </h2>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="form-group">
                            <label for="fm-title" class="text-gray-900 dark:text-white">タイトル:</label>
                            <input type="text" id="fm-title" placeholder="記事のタイトル" class="dark:bg-gray-700 dark:text-white">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-group">
                                <label for="fm-date" class="text-gray-900 dark:text-white">日付:</label>
                                <input type="date" id="fm-date" class="dark:bg-gray-700 dark:text-white">
                            </div>
                            <div class="form-group">
                                <label for="fm-category" class="text-gray-900 dark:text-white">カテゴリ:</label>
                                <input type="text" id="fm-category" placeholder="例: イベント, グッズ" class="dark:bg-gray-700 dark:text-white">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="fm-image" class="text-gray-900 dark:text-white">画像URL:</label>
                            <input type="text" id="fm-image" placeholder="https://example.com/image.jpg" class="dark:bg-gray-700 dark:text-white">
                        </div>
                        <div class="form-group flex items-center space-x-3">
                            <div class="flex-grow">
                                <label for="fm-categoryColor" class="text-gray-900 dark:text-white">カテゴリ色:</label>
                                <input type="text" id="fm-categoryColor" class="dark:bg-gray-700 dark:text-white" placeholder="例: blue, red, green">
                            </div>
                            <div class="pt-6">
                                <input type="color" id="fm-colorPicker" value="#4299e1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="fm-description" class="text-gray-900 dark:text-white">説明 (description):</label>
                            <textarea id="fm-description" rows="3" placeholder="記事の簡単な説明" class="dark:bg-gray-700 dark:text-white"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="fm-tags" class="text-gray-900 dark:text-white">タグ (カンマ区切り):</label>
                            <input type="text" id="fm-tags" placeholder="例: サンプル, Markdown, テスト" class="dark:bg-gray-700 dark:text-white">
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                    <div class="bg-gradient-to-r from-blue-500 to-cyan-500 p-4">
                        <h2 class="text-xl font-bold text-white flex items-center">
                            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                            Markdown入力
                        </h2>
                    </div>
                    <div class="p-6 space-y-4">
                        <!-- Enhanced Toolbar -->
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg space-y-3">
                            <!-- Headings Row -->
                            <div class="toolbar-group flex flex-wrap gap-2 items-center">
                                <span class="toolbar-label">見出し:</span>
                                <button id="btn-h1" class="blog-btn bg-green-600 hover:bg-green-700 text-white" title="見出し1">H1</button>
                                <button id="btn-h2" class="blog-btn bg-green-600 hover:bg-green-700 text-white" title="見出し2">H2</button>
                                <button id="btn-h3" class="blog-btn bg-green-600 hover:bg-green-700 text-white" title="見出し3">H3</button>
                            </div>
                            <!-- Formatting Row -->
                            <div class="toolbar-group flex flex-wrap gap-2 items-center">
                                <span class="toolbar-label">書式:</span>
                                <button id="btn-bold" class="blog-btn bg-primary-600 hover:bg-primary-700 text-white" title="太字"><b>B</b></button>
                                <button id="btn-italic" class="blog-btn bg-primary-600 hover:bg-primary-700 text-white" title="斜体"><i>I</i></button>
                                <button id="btn-strike" class="blog-btn bg-primary-600 hover:bg-primary-700 text-white" title="打ち消し線"><s>S</s></button>
                                <button id="btn-linebreak" class="blog-btn bg-blue-600 hover:bg-blue-700 text-white" title="改行">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path>
                                    </svg>
                                </button>
                            </div>
                            <!-- Elements Row -->
                            <div class="toolbar-group flex flex-wrap gap-2 items-center">
                                <span class="toolbar-label">要素:</span>
                                <button id="btn-link" class="blog-btn bg-primary-600 hover:bg-primary-700 text-white" title="リンク">Link</button>
                                <button id="btn-image" class="blog-btn bg-primary-600 hover:bg-primary-700 text-white" title="画像">Img</button>
                                <button id="btn-code" class="blog-btn bg-primary-600 hover:bg-primary-700 text-white" title="コード">Code</button>
                                <button id="btn-quote" class="blog-btn bg-primary-600 hover:bg-primary-700 text-white" title="引用">Quote</button>
                                <button id="btn-table" class="blog-btn bg-primary-600 hover:bg-primary-700 text-white" title="表">Table</button>
                                <button id="btn-map" class="blog-btn bg-emerald-600 hover:bg-emerald-700 text-white" title="地図を挿入">Map</button>
                                <button id="btn-ad" class="blog-btn bg-pink-600 hover:bg-pink-700 text-white" title="広告HTMLを挿入">Ad</button>
                            </div>
                        </div>
                        <textarea id="markdown-input" class="w-full p-4 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-800 dark:text-white dark:border-gray-600" placeholder="ここにMarkdownを記述してください..."></textarea>
                        
                        <!-- Search and Replace -->
                        <div class="search-replace-container">
                            <h3 class="text-lg font-semibold mb-3 text-gray-900 dark:text-white flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                検索・置換
                            </h3>
                            <div class="space-y-3">
                                <div class="flex flex-col sm:flex-row gap-3">
                                    <input type="text" id="search-input" placeholder="検索するテキスト" class="flex-1 p-3 border-2 border-gray-200 rounded-lg dark:bg-gray-700 dark:text-white dark:border-gray-600">
                                    <input type="text" id="replace-input" placeholder="置換するテキスト" class="flex-1 p-3 border-2 border-gray-200 rounded-lg dark:bg-gray-700 dark:text-white dark:border-gray-600">
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    <button id="btn-search" class="blog-btn bg-blue-500 hover:bg-blue-600 text-white">検索</button>
                                    <button id="btn-replace" class="blog-btn bg-orange-500 hover:bg-orange-600 text-white">置換</button>
                                    <button id="btn-replace-all" class="blog-btn bg-red-500 hover:bg-red-600 text-white">すべて置換</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- File Operations -->
                        <div class="flex flex-wrap gap-3 pt-4">
                            <button id="btn-file-open" class="blog-btn file-ops-btn bg-blue-500 hover:bg-blue-600 text-white">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                </svg>
                                ファイルを開く
                            </button>
                            <input type="file" id="file-input" accept=".md" class="hidden">
                            <button id="btn-template" class="blog-btn file-ops-btn bg-indigo-500 hover:bg-indigo-600 text-white">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                テンプレート
                            </button>
                            <button id="btn-history" class="blog-btn file-ops-btn bg-teal-500 hover:bg-teal-600 text-white">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                履歴
                            </button>
                            <button id="btn-reset" class="blog-btn file-ops-btn bg-red-500 hover:bg-red-600 text-white">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                リセット
                            </button>
                            <button id="btn-copy" class="blog-btn file-ops-btn bg-green-500 hover:bg-green-600 text-white">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                全文をコピー
                            </button>
                            <button id="btn-download" class="blog-btn file-ops-btn bg-purple-500 hover:bg-purple-600 text-white">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                .mdでダウンロード
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <section class="space-y-6">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden sticky top-24">
                    <div class="bg-gradient-to-r from-green-500 to-teal-500 p-4">
                        <h2 class="text-xl font-bold text-white flex items-center">
                            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                            プレビュー
                        </h2>
                    </div>
                    <div class="p-6">
                        <div id="preview-area" class="markdown-preview prose lg:prose-xl max-w-none dark:prose-invert"></div>
                    </div>
                </div>
            </section>
        </div>
        
        <!-- Mobile Floating Action Button -->
        <button id="mobile-fab" class="fab md:hidden">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
        </button>
        
        <!-- Mobile Quick Actions Menu -->
        <div id="mobile-menu" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
            <div class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 rounded-t-2xl p-6 transform translate-y-full transition-transform duration-300" id="mobile-menu-content">
                <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
                <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">クイックアクション</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button id="mobile-bold" class="blog-btn bg-primary-600 hover:bg-primary-700 text-white">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2"></path>
                        </svg>
                        太字
                    </button>
                    <button id="mobile-italic" class="blog-btn bg-primary-600 hover:bg-primary-700 text-white">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 4l8 8-8 8"></path>
                        </svg>
                        斜体
                    </button>
                    <button id="mobile-h2" class="blog-btn bg-green-600 hover:bg-green-700 text-white">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                        見出し2
                    </button>
                    <button id="mobile-link" class="blog-btn bg-blue-600 hover:bg-blue-700 text-white">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                        </svg>
                        リンク
                    </button>
                    <button id="mobile-save" class="blog-btn bg-green-500 hover:bg-green-600 text-white">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                        </svg>
                        保存
                    </button>
                    <button id="mobile-copy" class="blog-btn bg-purple-500 hover:bg-purple-600 text-white">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                        コピー
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- App Modal Root (for styled modals) -->
    <div id="modal-root"></div>

    <footer class="bg-gray-100 dark:bg-gray-950">
        <div class="container mx-auto px-6 py-12 text-center text-gray-500 dark:text-gray-400">
            <p>&copy; 2025 ポイ活Pay太郎. All Rights Reserved.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const markdownInput = document.getElementById('markdown-input');
            const previewArea = document.getElementById('preview-area');
            const fmTitle = document.getElementById('fm-title');
            const fmDate = document.getElementById('fm-date');
            const fmImage = document.getElementById('fm-image');
            const fmCategory = document.getElementById('fm-category');
            const fmCategoryColor = document.getElementById('fm-categoryColor');
            const fmDescription = document.getElementById('fm-description');
            const fmTags = document.getElementById('fm-tags');
            const fmColorPicker = document.getElementById('fm-colorPicker');
            const btnBold = document.getElementById('btn-bold');
            const btnItalic = document.getElementById('btn-italic');
            const btnStrike = document.getElementById('btn-strike');
            const btnH1 = document.getElementById('btn-h1');
            const btnH2 = document.getElementById('btn-h2');
            const btnH3 = document.getElementById('btn-h3');
            const btnLinebreak = document.getElementById('btn-linebreak');
            const btnLink = document.getElementById('btn-link');
            const btnImage = document.getElementById('btn-image');
            const btnCode = document.getElementById('btn-code');
            const btnQuote = document.getElementById('btn-quote');
            const btnTable = document.getElementById('btn-table');
            const btnMap = document.getElementById('btn-map');
            const btnAd = document.getElementById('btn-ad');
            const btnFileOpen = document.getElementById('btn-file-open');
            const fileInput = document.getElementById('file-input');
            const btnReset = document.getElementById('btn-reset');
            const btnCopy = document.getElementById('btn-copy');
            const btnDownload = document.getElementById('btn-download');
            const btnTemplate = document.getElementById('btn-template');
            const btnHistory = document.getElementById('btn-history');
            const searchInput = document.getElementById('search-input');
            const replaceInput = document.getElementById('replace-input');
            const btnSearch = document.getElementById('btn-search');
            const btnReplace = document.getElementById('btn-replace');
            const btnReplaceAll = document.getElementById('btn-replace-all');
            const btnSplitView = document.getElementById('btn-split-view');
            const btnTabView = document.getElementById('btn-tab-view');
            const layoutToggle = document.getElementById('layout-toggle');
            const tabView = document.getElementById('tab-view');
            const splitView = document.getElementById('split-view');
            const tabEditor = document.getElementById('tab-editor');
            const tabPreview = document.getElementById('tab-preview');
            const tabEditorContent = document.getElementById('tab-editor-content');
            const tabPreviewContent = document.getElementById('tab-preview-content');

            const LOCAL_STORAGE_KEY = 'markdownEditorContent';

            // ---------------- Modal helpers ----------------
            const modalRoot = document.getElementById('modal-root');
            const closeModal = (overlay) => {
                if (!overlay) return;
                overlay.classList.remove('show');
                setTimeout(() => overlay.remove(), 200);
            };

            const showFormModal = ({ title, fields, submitText = 'OK', cancelText = 'キャンセル' }) => {
                return new Promise((resolve, reject) => {
                    const overlay = document.createElement('div');
                    overlay.className = 'modal-overlay';
                    const bodyHtml = fields.map(f => {
                        const common = `id="${f.id}" class="modal-input" placeholder="${f.placeholder || ''}"`;
                        if ((f.type || 'text') === 'textarea') {
                            const rows = f.rows || 6;
                            return `<div><label class="modal-label" for="${f.id}">${f.label}</label><textarea ${common} rows="${rows}">${f.value || ''}</textarea></div>`;
                        }
                        if ((f.type || 'text') === 'select') {
                            const opts = (f.options || []).map(o => `<option value="${o.value}">${o.label}</option>`).join('');
                            return `<div><label class="modal-label" for="${f.id}">${f.label}</label><select ${common}>${opts}</select></div>`;
                        }
                        return `<div><label class="modal-label" for="${f.id}">${f.label}</label><input ${common} type="${f.type || 'text'}" value="${f.value || ''}"></div>`;
                    }).join('');
                    overlay.innerHTML = `
                        <div class="modal-container">
                            <div class="modal-header">
                                <h3 class="text-base font-semibold">${title}</h3>
                                <button class="modal-close" aria-label="close">×</button>
                            </div>
                            <div class="modal-body space-y-4">${bodyHtml}</div>
                            <div class="modal-footer modal-actions">
                                <button class="blog-btn bg-gray-200 text-gray-800 hover:bg-gray-300" data-action="cancel">${cancelText}</button>
                                <button class="blog-btn bg-primary-600 text-white hover:bg-primary-700" data-action="ok">${submitText}</button>
                            </div>
                        </div>
                    `;
                    modalRoot.appendChild(overlay);
                    requestAnimationFrame(() => overlay.classList.add('show'));

                    const cleanUp = () => closeModal(overlay);
                    overlay.addEventListener('click', (e) => { if (e.target === overlay) cleanUp(); });
                    overlay.querySelector('.modal-close').addEventListener('click', cleanUp);
                    overlay.querySelector('[data-action="cancel"]').addEventListener('click', () => { cleanUp(); reject('cancel'); });
                    overlay.querySelector('[data-action="ok"]').addEventListener('click', () => {
                        const values = {};
                        fields.forEach(f => {
                            const el = overlay.querySelector(`#${f.id}`);
                            values[f.id] = el ? el.value : '';
                        });
                        cleanUp();
                        resolve(values);
                    });
                });
            };

            const showConfirmModal = ({ title, message, okText = 'OK', cancelText = 'キャンセル', tone = 'warning' }) => {
                return new Promise((resolve, reject) => {
                    const overlay = document.createElement('div');
                    overlay.className = 'modal-overlay';
                    overlay.innerHTML = `
                        <div class="modal-container">
                            <div class="modal-header">
                                <h3 class="text-base font-semibold">${title}</h3>
                                <button class="modal-close" aria-label="close">×</button>
                            </div>
                            <div class="modal-body">
                                <p class="text-sm">${message}</p>
                            </div>
                            <div class="modal-footer modal-actions">
                                <button class="blog-btn bg-gray-200 text-gray-800 hover:bg-gray-300" data-action="cancel">${cancelText}</button>
                                <button class="blog-btn ${tone === 'danger' ? 'bg-red-600 hover:bg-red-700' : 'bg-primary-600 hover:bg-primary-700'} text-white" data-action="ok">${okText}</button>
                            </div>
                        </div>
                    `;
                    modalRoot.appendChild(overlay);
                    requestAnimationFrame(() => overlay.classList.add('show'));

                    const cleanUp = () => closeModal(overlay);
                    overlay.addEventListener('click', (e) => { if (e.target === overlay) cleanUp(); });
                    overlay.querySelector('.modal-close').addEventListener('click', cleanUp);
                    overlay.querySelector('[data-action="cancel"]').addEventListener('click', () => { cleanUp(); reject('cancel'); });
                    overlay.querySelector('[data-action="ok"]').addEventListener('click', () => { cleanUp(); resolve(true); });
                });
            };

            const showSelectModal = ({ title, options = [], submitText = 'OK', cancelText = 'キャンセル' }) => {
                return new Promise((resolve, reject) => {
                    const overlay = document.createElement('div');
                    overlay.className = 'modal-overlay';
                    overlay.innerHTML = `
                        <div class="modal-container">
                            <div class="modal-header">
                                <h3 class="text-base font-semibold">${title}</h3>
                                <button class="modal-close" aria-label="close">×</button>
                            </div>
                            <div class="modal-body space-y-4">
                                <div>
                                    <label class="modal-label" for="modal-select">選択</label>
                                    <select id="modal-select" class="modal-input">
                                        ${options.map(o => `<option value="${o.value}">${o.label}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <div class="modal-footer modal-actions">
                                <button class="blog-btn bg-gray-200 text-gray-800 hover:bg-gray-300" data-action="cancel">${cancelText}</button>
                                <button class="blog-btn bg-primary-600 text-white hover:bg-primary-700" data-action="ok">${submitText}</button>
                            </div>
                        </div>
                    `;
                    modalRoot.appendChild(overlay);
                    requestAnimationFrame(() => overlay.classList.add('show'));

                    const cleanUp = () => closeModal(overlay);
                    overlay.addEventListener('click', (e) => { if (e.target === overlay) cleanUp(); });
                    overlay.querySelector('.modal-close').addEventListener('click', cleanUp);
                    overlay.querySelector('[data-action="cancel"]').addEventListener('click', () => { cleanUp(); reject('cancel'); });
                    overlay.querySelector('[data-action="ok"]').addEventListener('click', () => {
                        const select = overlay.querySelector('#modal-select');
                        const value = select ? select.value : null;
                        cleanUp();
                        resolve(value);
                    });
                });
            };

            // Debounce function for preview update
            const debounce = (func, delay) => {
                let timeoutId;
                return (...args) => {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => func.apply(null, args), delay);
                };
            };

            const updatePreview = debounce(() => {
                // Get current active preview area (split view or tab view)
                const currentPreviewArea = splitView.classList.contains('hidden')
                    ? tabPreviewContent.querySelector('#preview-area')
                    : previewArea;

                if (marked && currentPreviewArea) {
                    currentPreviewArea.innerHTML = marked.parse(markdownInput.value);
                }
            }, 300);

            const saveContent = () => {
                const content = { 
                    title: fmTitle.value, 
                    date: fmDate.value, 
                    image: fmImage.value, 
                    category: fmCategory.value, 
                    categoryColor: fmCategoryColor.value, 
                    description: fmDescription.value, 
                    tags: fmTags.value, 
                    markdownBody: markdownInput.value,
                    cursorPosition: markdownInput.selectionStart,
                    scrollPosition: markdownInput.scrollTop
                };
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(content));
            };

            // Auto-save every 5 seconds
            setInterval(saveContent, 5000);

            // Version history
            const HISTORY_KEY = 'markdownEditorHistory';
            let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');

            const saveToHistory = () => {
                const currentContent = {
                    title: fmTitle.value,
                    date: fmDate.value,
                    image: fmImage.value,
                    category: fmCategory.value,
                    categoryColor: fmCategoryColor.value,
                    description: fmDescription.value,
                    tags: fmTags.value,
                    markdownBody: markdownInput.value,
                    timestamp: new Date().toISOString()
                };
                history.unshift(currentContent);
                if (history.length > 20) history.pop(); // Keep only last 20 versions
                localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            };

            // Save to history on input
            markdownInput.addEventListener('input', debounce(saveToHistory, 2000));

            // Templates
            const templates = {
                blog: {
                    title: 'ブログ記事',
                    markdownBody: `# ブログ記事のタイトル

## 導入

この記事では、[トピック]について説明します。

## 本文

### セクション1

内容をここに記述してください。

### セクション2

- ポイント1
- ポイント2
- ポイント3

## まとめ

まとめの内容をここに記述してください。

---

*この記事は参考情報です。*`
                },
                document: {
                    title: '技術ドキュメント',
                    markdownBody: `# 技術ドキュメント

## 概要

このドキュメントは[プロジェクト/システム]の技術仕様を記載します。

## 仕様

### 要件

- 要件1
- 要件2
- 要件3

### 実装

\`\`\`javascript
// サンプルコード
function example() {
    console.log('Hello World');
}
\`\`\`

### API

| エンドポイント | メソッド | 説明 |
|---------------|---------|------|
| /api/example | GET | サンプル取得 |

## 参考資料

- [参考リンク1](https://example.com)
- [参考リンク2](https://example.com)`
                },
                guide: {
                    title: 'ガイド記事',
                    markdownBody: `# 初心者向けガイド

## このガイドについて

このガイドでは、[トピック]の基本から応用までを解説します。

## 準備

### 必要なもの

- アイテム1
- アイテム2
- アイテム3

### インストール

1. ステップ1
2. ステップ2
3. ステップ3

## 基本操作

### 基本操作1

操作の説明をここに記述してください。

### 基本操作2

操作の説明をここに記述してください。

## よくある質問

**Q: 質問1?**
A: 回答1

**Q: 質問2?**
A: 回答2

## 次のステップ

このガイドの次に学ぶべき内容：
- [関連トピック1]
- [関連トピック2]`
                }
            };

            // Load custom templates from localStorage
            const loadCustomTemplates = () => {
                const custom = localStorage.getItem('markdownCustomTemplates');
                return custom ? JSON.parse(custom) : {};
            };

            // Save custom templates to localStorage
            const saveCustomTemplates = (customTemplates) => {
                localStorage.setItem('markdownCustomTemplates', JSON.stringify(customTemplates));
            };

            // Template selection (modal)
            const selectTemplate = async () => {
                const customTemplates = loadCustomTemplates();
                const allTemplates = { ...templates, ...customTemplates };
                const templateKeys = Object.keys(allTemplates);
                const options = templateKeys.map((key, i) => ({ value: key, label: `${i + 1}. ${allTemplates[key].title}` }));
                options.push({ value: '__new__', label: `${options.length + 1}. 新規テンプレート作成` });

                try {
                    const value = await showSelectModal({ title: 'テンプレートを選択', options, submitText: '適用' });
                    if (!value) return;
                    if (value === '__new__') {
                        await createNewTemplate();
                        return;
                    }

                    const template = allTemplates[value];
                    if (!template) return;

                    const currentFmTitle = document.getElementById('fm-title');
                    const currentMarkdownInput = document.getElementById('markdown-input');
                    const currentFmDate = document.getElementById('fm-date');

                    if (currentFmTitle) currentFmTitle.value = template.title;
                    if (currentMarkdownInput) currentMarkdownInput.value = template.markdownBody;
                    if (currentFmDate) currentFmDate.valueAsDate = new Date();

                    updatePreview();
                    saveContent();
                    showNotification('テンプレートを適用しました！', 'success');
                } catch (_) { /* canceled */ }
            };

            // Create new template (modal)
            const createNewTemplate = async () => {
                const currentFmTitle = document.getElementById('fm-title');
                const currentMarkdownInput = document.getElementById('markdown-input');
                try {
                    const { name } = await showFormModal({
                        title: '新規テンプレート',
                        submitText: '保存',
                        fields: [ { id: 'name', label: 'テンプレート名', placeholder: '例）ブログ初期', value: '' } ]
                    });
                    if (!name) return;

                    const customTemplates = loadCustomTemplates();
                    if (customTemplates[name]) {
                        try {
                            await showConfirmModal({
                                title: '上書き確認',
                                message: `"${name}" は既に存在します。上書きしますか？`,
                                okText: '上書き',
                                cancelText: 'やめる',
                                tone: 'warning'
                            });
                        } catch (_) { return; }
                    }

                    customTemplates[name] = {
                        title: currentFmTitle ? currentFmTitle.value : name,
                        markdownBody: currentMarkdownInput ? currentMarkdownInput.value : ''
                    };

                    saveCustomTemplates(customTemplates);
                    showNotification(`テンプレート"${name}"を保存しました！`, 'success');
                } catch (_) { /* canceled */ }
            };

            // History selection (modal)
            const selectHistory = async () => {
                if (history.length === 0) {
                    showNotification('履歴がありません。', 'info');
                    return;
                }
                const options = history.map((item, i) => ({
                    value: String(i),
                    label: `${i + 1}. ${item.title || '無題'} (${new Date(item.timestamp).toLocaleString()})`
                }));
                try {
                    const selected = await showSelectModal({ title: '履歴から復元', options, submitText: '復元' });
                    if (selected == null) return;
                    const idx = parseInt(selected, 10);
                    if (isNaN(idx) || idx < 0 || idx >= history.length) return;
                    const version = history[idx];
                    fmTitle.value = version.title || '';
                    fmDate.value = version.date || '';
                    fmImage.value = version.image || '';
                    fmCategory.value = version.category || '';
                    fmCategoryColor.value = version.categoryColor || '';
                    fmDescription.value = version.description || '';
                    fmTags.value = version.tags || '';
                    markdownInput.value = version.markdownBody || '';
                    updatePreview();
                    saveContent();
                    showNotification('過去のバージョンに復元しました！', 'success');
                } catch (_) { /* canceled */ }
            };

            // Keyboard shortcuts
            markdownInput.addEventListener('keydown', (e) => {
                // Shift+Enter for line break
                if (e.shiftKey && e.key === 'Enter') {
                    e.preventDefault();
                    const cursorPos = markdownInput.selectionStart;
                    const textBefore = markdownInput.value.substring(0, cursorPos);
                    const textAfter = markdownInput.value.substring(cursorPos);
                    markdownInput.value = textBefore + '<br>\n' + textAfter;
                    markdownInput.selectionStart = cursorPos + 5; // <br>\n is 5 characters
                    markdownInput.selectionEnd = cursorPos + 5;
                    updatePreview(); saveContent();
                    return;
                }

                if (e.ctrlKey || e.metaKey) {
                    switch (e.key) {
                        case 'b':
                            e.preventDefault();
                            wrapText('**', '**', '太字');
                            break;
                        case 'i':
                            e.preventDefault();
                            wrapText('*', '*', '斜体');
                            break;
                        case 's':
                            if (e.shiftKey) {
                                e.preventDefault();
                                wrapText('~~', '~~', '打ち消し線');
                            } else {
                                e.preventDefault();
                                saveContent();
                                showNotification('保存しました！', 'success');
                            }
                            break;
                        case '1':
                        case '2':
                        case '3':
                        case '4':
                        case '5':
                        case '6':
                            e.preventDefault();
                            const level = parseInt(e.key);
                            const hashes = '#'.repeat(level) + ' ';
                            insertMarkdown(hashes, `見出し${level}`);
                            break;
                        case 'k':
                            e.preventDefault();
                            insertLink();
                            break;
                        case 'g':
                            e.preventDefault();
                            insertImage();
                            break;
                        case 'q':
                            e.preventDefault();
                            insertMarkdown('> ', '引用');
                            break;
                        case 'm':
                            e.preventDefault();
                            insertTable();
                            break;
                    }
                }
            });

            // Drag and drop for file upload
            markdownInput.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'copy';
            });

            markdownInput.addEventListener('drop', (e) => {
                e.preventDefault();
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type === 'text/markdown' || file.name.endsWith('.md')) {
                        const reader = new FileReader();
                        reader.onload = (e) => parseAndLoadMarkdown(e.target.result);
                        reader.readAsText(file);
                    } else {
                        showNotification('Markdownファイルのみ対応しています。', 'error');
                    }
                }
            });

            // Search and replace functionality
            let searchIndex = -1;
            const searchText = () => {
                const text = searchInput.value;
                if (!text) return;
                const content = markdownInput.value;
                const index = content.indexOf(text, searchIndex + 1);
                if (index !== -1) {
                    searchIndex = index;
                    markdownInput.focus();
                    markdownInput.selectionStart = index;
                    markdownInput.selectionEnd = index + text.length;
                } else {
                    showNotification('見つかりませんでした。', 'info');
                    searchIndex = -1;
                }
            };

            const replaceText = () => {
                const text = searchInput.value;
                const replace = replaceInput.value;
                if (!text) return;
                const content = markdownInput.value;
                if (markdownInput.selectionStart !== markdownInput.selectionEnd) {
                    const start = markdownInput.selectionStart;
                    const end = markdownInput.selectionEnd;
                    const selected = content.substring(start, end);
                    if (selected === text) {
                        markdownInput.value = content.substring(0, start) + replace + content.substring(end);
                        markdownInput.selectionStart = start + replace.length;
                        markdownInput.selectionEnd = start + replace.length;
                        updatePreview(); saveContent();
                        searchIndex = start;
                    }
                }
            };

            const replaceAllText = () => {
                const text = searchInput.value;
                const replace = replaceInput.value;
                if (!text) return;
                const content = markdownInput.value;
                markdownInput.value = content.replaceAll(text, replace);
                updatePreview(); saveContent();
                searchIndex = -1;
                showNotification('すべて置換しました。', 'success');
            };

            const wrapText = (before, after, placeholder = '') => {
                const start = markdownInput.selectionStart, end = markdownInput.selectionEnd, val = markdownInput.value;
                const selected = val.substring(start, end);
                const replacement = selected ? before + selected + after : before + placeholder + after;
                markdownInput.value = val.substring(0, start) + replacement + val.substring(end);
                markdownInput.focus();
                markdownInput.selectionStart = start + before.length;
                markdownInput.selectionEnd = start + before.length + (selected ? selected.length : placeholder.length);
                updatePreview(); saveContent();
            };

            const insertMarkdown = (syntax, placeholder) => wrapText(syntax, '', placeholder);
            const insertLink = async () => {
                try {
                    const values = await showFormModal({
                        title: 'リンクを挿入',
                        submitText: '挿入',
                        fields: [
                            { id: 'text', label: 'リンクテキスト', placeholder: '例）公式サイト', value: '' },
                            { id: 'url', label: 'URL', placeholder: 'https://example.com', value: 'https://' }
                        ]
                    });
                    if (values.url) {
                        const text = values.text && values.text.trim().length > 0 ? values.text.trim() : 'リンクテキスト';
                        wrapText('[', `](${values.url})`, text);
                    }
                } catch (_) { /* canceled */ }
            };

            const insertImage = async () => {
                try {
                    const values = await showFormModal({
                        title: '画像を挿入',
                        submitText: '挿入',
                        fields: [
                            { id: 'alt', label: '代替テキスト', placeholder: '画像の説明', value: '画像の説明' },
                            { id: 'url', label: '画像URL', placeholder: 'https://example.com/image.jpg', value: 'https://' }
                        ]
                    });
                    if (values.url) {
                        insertMarkdown(`\n![${values.alt || '画像'}](${values.url})\n`, '');
                    }
                } catch (_) { /* canceled */ }
            };
            const insertTable = () => insertMarkdown(`\n| H1 | H2 |\n|---|---|\n| D1 | D2 |\n`, '');

            // Insert Map (Google Maps iframe or coordinates)
            const insertMap = async () => {
                try {
                    const values = await showFormModal({
                        title: '地図を挿入',
                        submitText: '挿入',
                        fields: [
                            { id: 'mode', label: 'モード', type: 'select', options: [
                                { value: 'iframe', label: '埋め込みHTML (iframe)' },
                                { value: 'coords', label: '座標から生成 (緯度/経度)' }
                            ] },
                            { id: 'iframe', label: '埋め込みHTML (Googleマップの共有→地図を埋め込むで取得)', type: 'textarea', rows: 6, placeholder: '<iframe ...></iframe>' },
                            { id: 'lat', label: '緯度 (例: 35.681236)', type: 'text', placeholder: '35.681236' },
                            { id: 'lng', label: '経度 (例: 139.767125)', type: 'text', placeholder: '139.767125' },
                            { id: 'zoom', label: 'ズーム (1-20)', type: 'number', placeholder: '15', value: '15' },
                            { id: 'width', label: '幅 (px or %)', type: 'text', placeholder: '100%' , value: '100%'},
                            { id: 'height', label: '高さ (px)', type: 'text', placeholder: '300' , value: '300'}
                        ]
                    });
                    let md = '';
                    const width = values.width || '100%';
                    const height = values.height || '300';
                    if (values.mode === 'iframe' && values.iframe) {
                        // Sanitize minimal: only allow iframe tag
                        const html = values.iframe.trim();
                        md = `\n<div class="map-embed" style="width:${width}; max-width:100%;">${html.replace(/width\s*=\s*"[^"]*"/i, `width=\"${width}\"`).replace(/height\s*=\s*"[^"]*"/i, `height=\"${height}\"`)}</div>\n`;
                    } else if (values.mode === 'coords' && values.lat && values.lng) {
                        const lat = values.lat.trim();
                        const lng = values.lng.trim();
                        const zoom = parseInt(values.zoom || '15', 10);
                        const src = `https://maps.google.com/maps?q=${encodeURIComponent(lat)},${encodeURIComponent(lng)}&t=&z=${zoom}&ie=UTF8&iwloc=&output=embed`;
                        md = `\n<div class="map-embed" style="width:${width}; max-width:100%;"><iframe width="${width}" height="${height}" src="${src}" style="border:0;" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe></div>\n`;
                    }
                    if (md) insertMarkdown(md, '');
                } catch (_) { /* canceled */ }
            };

            // Insert Ad HTML (raw)
            const insertAdHtml = async () => {
                try {
                    const values = await showFormModal({
                        title: '広告HTMLを挿入',
                        submitText: '挿入',
                        fields: [
                            { id: 'html', label: 'HTMLコード', type: 'textarea', rows: 8, placeholder: '<a href=...>...</a>' },
                            { id: 'wrap', label: 'ラッパーを付ける (optional class)', type: 'text', placeholder: 'ad-container (任意)' }
                        ]
                    });
                    let html = (values.html || '').trim();
                    if (!html) return;
                    const wrapperClass = (values.wrap || '').trim();
                    if (wrapperClass) {
                        html = `<div class="${wrapperClass}">${html}</div>`;
                    }
                    const md = `\n<div class="ad-embed">${html}</div>\n`;
                    insertMarkdown(md, '');
                } catch (_) { /* canceled */ }
            };

            const generateFullMarkdown = () => {
                const escape = (str) => String(str || '').replace(/\\/g, '\\\\').replace(/"/g, '\"');
                const data = { title: fmTitle.value.trim(), date: fmDate.value.trim(), image: fmImage.value.trim(), category: fmCategory.value.trim(), categoryColor: fmCategoryColor.value.trim(), description: fmDescription.value.trim(), tags: fmTags.value.trim() };
                let frontmatter = '---\n';
                frontmatter += `title: "${escape(data.title)}"\n`;
                frontmatter += `date: "${data.date}"\n`;
                frontmatter += `image: "${data.image}"\n`;
                frontmatter += `category: "${escape(data.category)}"\n`;
                frontmatter += `categoryColor: "${data.categoryColor}"\n`;
                frontmatter += `description: "${escape(data.description)}"\n`;
                const tagsArray = data.tags ? data.tags.split(',').map(tag => `"${escape(tag.trim())}"`) : [];
                frontmatter += `tags: [${tagsArray.join(', ')}]\n`;
                frontmatter += '---\n\n';
                const markdownBody = markdownInput.value;
                return frontmatter + markdownBody;
            };

            const copyMarkdown = () => {
                const fullContent = generateFullMarkdown();
                navigator.clipboard.writeText(fullContent).then(() => {
                    showNotification('全文がクリップボードにコピーされました！', 'success');
                }, () => {
                    showNotification('コピーに失敗しました。ブラウザの権限を確認してください。', 'error');
                });
            };

            const resetEditor = async () => {
                try {
                    await showConfirmModal({
                        title: 'リセットの確認',
                        message: '本当にリセットしますか？保存された内容も消えます。',
                        okText: 'リセットする',
                        cancelText: 'やめる',
                        tone: 'danger'
                    });
                    [fmTitle, fmImage, fmCategory, fmCategoryColor, fmDescription, fmTags, markdownInput].forEach(el => el.value = '');
                    fmDate.valueAsDate = new Date();
                    localStorage.removeItem(LOCAL_STORAGE_KEY);
                    updatePreview();
                    showNotification('エディタをリセットしました。', 'info');
                } catch (_) { /* canceled */ }
            };

            const parseAndLoadMarkdown = (fullMarkdown) => {
                const match = /^---\s*([\s\S]*?)\s*---/.exec(fullMarkdown);
                let body = fullMarkdown;
                if (match) {
                    const frontmatterRaw = match[1];
                    body = fullMarkdown.substring(match[0].length).trim();
                    const attrs = {};
                    frontmatterRaw.split('\n').forEach(line => {
                        const parts = line.split(':');
                        if (parts.length >= 2) {
                            const key = parts[0].trim();
                            let value = parts.slice(1).join(':').trim().replace(/^"|"$/g, '');
                            if (key === 'tags') value = value.slice(1, -1).split(',').map(t => t.trim().replace(/^"|"$/g, '')).join(', ');
                            attrs[key] = value;
                        }
                    });
                    fmTitle.value = attrs.title || ''; fmDate.value = attrs.date || ''; fmImage.value = attrs.image || '';
                    fmCategory.value = attrs.category || ''; fmCategoryColor.value = attrs.categoryColor || '';
                    fmDescription.value = attrs.description || ''; fmTags.value = attrs.tags || '';
                }
                markdownInput.value = body;
                updatePreview(); saveContent();
            };

            const loadFile = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => parseAndLoadMarkdown(e.target.result);
                reader.readAsText(file);
            };

            const loadContent = () => {
                const saved = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (saved) {
                    const content = JSON.parse(saved);
                    fmTitle.value = content.title || '';
                    fmDate.value = content.date || new Date().toISOString().split('T')[0];
                    fmImage.value = content.image || '';
                    fmCategory.value = content.category || '';
                    fmCategoryColor.value = content.categoryColor || '';
                    fmDescription.value = content.description || '';
                    fmTags.value = content.tags || '';
                    markdownInput.value = content.markdownBody || '';
                    
                    // Restore cursor position if saved
                    if (content.cursorPosition !== undefined) {
                        savedCursorPosition = content.cursorPosition;
                        setTimeout(() => {
                            markdownInput.selectionStart = savedCursorPosition;
                            markdownInput.selectionEnd = savedCursorPosition;
                        }, 100);
                    }
                    
                    // Restore scroll position if saved
                    if (content.scrollPosition !== undefined) {
                        markdownInputScrollTop = content.scrollPosition;
                        setTimeout(() => {
                            markdownInput.scrollTop = markdownInputScrollTop;
                        }, 100);
                    }
                } else {
                    fmDate.valueAsDate = new Date();
                }
                updatePreview();
            };

            [...document.querySelectorAll('input, textarea')].forEach(el => el.addEventListener('input', () => { updatePreview(); saveContent(); }));
            fmColorPicker.addEventListener('input', () => { fmCategoryColor.value = fmColorPicker.value; saveContent(); });
            btnH1.addEventListener('click', () => insertMarkdown('# ', '見出し1'));
            btnH2.addEventListener('click', () => insertMarkdown('## ', '見出し2'));
            btnH3.addEventListener('click', () => insertMarkdown('### ', '見出し3'));
            btnLinebreak.addEventListener('click', () => {
                const cursorPos = markdownInput.selectionStart;
                const textBefore = markdownInput.value.substring(0, cursorPos);
                const textAfter = markdownInput.value.substring(cursorPos);
                markdownInput.value = textBefore + '<br>\n' + textAfter;
                markdownInput.selectionStart = cursorPos + 5;
                markdownInput.selectionEnd = cursorPos + 5;
                markdownInput.focus();
                updatePreview(); saveContent();
            });
            btnBold.addEventListener('click', () => wrapText('**', '**', '太字'));
            btnItalic.addEventListener('click', () => wrapText('*', '*', '斜体'));
            btnStrike.addEventListener('click', () => wrapText('~~', '~~', '打ち消し線'));
            btnLink.addEventListener('click', insertLink);
            btnImage.addEventListener('click', insertImage);
            btnCode.addEventListener('click', () => wrapText('\n```\n', '\n```', 'code'));
            btnQuote.addEventListener('click', () => insertMarkdown('> ', '引用'));
            btnTable.addEventListener('click', insertTable);
            btnMap.addEventListener('click', insertMap);
            btnAd.addEventListener('click', insertAdHtml);
            btnFileOpen.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', loadFile);
            btnReset.addEventListener('click', resetEditor);
            btnCopy.addEventListener('click', copyMarkdown);
            btnDownload.addEventListener('click', () => {
                const fullContent = generateFullMarkdown();
                const title = fmTitle.value.trim() || 'untitled';
                const blob = new Blob([fullContent], { type: 'text/markdown;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${title}.md`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('Markdownファイルがダウンロードされました！', 'success');
            });
            btnSearch.addEventListener('click', searchText);
            btnReplace.addEventListener('click', replaceText);
            btnReplaceAll.addEventListener('click', replaceAllText);
            btnTemplate.addEventListener('click', selectTemplate);
            btnHistory.addEventListener('click', selectHistory);

            // Layout toggle
            const editorSection = document.querySelector('#split-view section:first-child');
            const previewSection = document.querySelector('#split-view section:last-child');

            const switchToSplitView = () => {
                if (!tabView.classList.contains('hidden')) {
                    tabView.classList.add('hidden');
                    splitView.classList.remove('hidden');
                    btnSplitView.classList.add('active');
                    btnTabView.classList.remove('active');
                    
                    // Move sections back to split view if they're in tab view
                    const editorInTab = tabEditorContent.querySelector('section');
                    const previewInTab = tabPreviewContent.querySelector('section');
                    
                    if (editorInTab) {
                        splitView.appendChild(editorInTab);
                    }
                    if (previewInTab) {
                        splitView.appendChild(previewInTab);
                    }
                } else {
                    // Show notification that we're already in split view
                    showNotification('すでに分割ビューです。', 'info');
                }
            };

            const switchToTabView = () => {
                // Always ensure Tab View is visible and Split View is hidden
                splitView.classList.add('hidden');
                tabView.classList.remove('hidden');
                btnTabView.classList.add('active');
                btnSplitView.classList.remove('active');

                // Move sections into tab containers if not already present
                if (!tabEditorContent.querySelector('section')) {
                    const editorFromSplit = document.querySelector('#split-view section:first-child');
                    if (editorFromSplit) {
                        tabEditorContent.appendChild(editorFromSplit);
                    }
                }
                if (!tabPreviewContent.querySelector('section')) {
                    const previewFromSplit = document.querySelector('#split-view section:last-child');
                    if (previewFromSplit) {
                        tabPreviewContent.appendChild(previewFromSplit);
                    }
                }

                // Ensure preview area exists in tab preview content
                if (!tabPreviewContent.querySelector('#preview-area')) {
                    const fallbackPreview = document.createElement('div');
                    fallbackPreview.id = 'preview-area';
                    fallbackPreview.className = 'markdown-preview prose lg:prose-xl max-w-none dark:prose-invert';
                    tabPreviewContent.appendChild(fallbackPreview);
                }

                // Default to showing the editor tab content
                tabEditorContent.classList.remove('hidden');
                tabPreviewContent.classList.add('hidden');
                tabEditor.classList.add('bg-gray-100', 'dark:bg-gray-800', 'text-gray-900', 'dark:text-white');
                tabEditor.classList.remove('bg-white', 'dark:bg-gray-900', 'text-gray-500', 'dark:text-gray-400');
                tabPreview.classList.remove('bg-gray-100', 'dark:bg-gray-800', 'text-gray-900', 'dark:text-white');
                tabPreview.classList.add('bg-white', 'dark:bg-gray-900', 'text-gray-500', 'dark:text-gray-400');

                // Update preview once to sync state
                updatePreview();
            };

            // Notification system
            const showNotification = (message, type = 'success') => {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full`;
                
                switch (type) {
                    case 'success':
                        notification.className += ' bg-green-500 text-white';
                        break;
                    case 'error':
                        notification.className += ' bg-red-500 text-white';
                        break;
                    case 'info':
                        notification.className += ' bg-blue-500 text-white';
                        break;
                    default:
                        notification.className += ' bg-gray-500 text-white';
                }
                
                notification.textContent = message;
                document.body.appendChild(notification);
                
                // Animate in
                setTimeout(() => {
                    notification.classList.remove('translate-x-full');
                }, 100);
                
                // Animate out and remove
                setTimeout(() => {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
            };

            btnSplitView.addEventListener('click', switchToSplitView);
            btnTabView.addEventListener('click', switchToTabView);

            // Tab switching with improved mobile experience
            tabEditor.addEventListener('click', () => {
                // Save preview scroll position
                const currentPreviewArea = tabPreviewContent.querySelector('#preview-area') || previewArea;
                if (currentPreviewArea) {
                    previewScrollTop = currentPreviewArea.scrollTop;
                }

                tabEditorContent.classList.remove('hidden');
                tabPreviewContent.classList.add('hidden');
                tabEditor.classList.add('bg-gray-100', 'dark:bg-gray-800', 'text-gray-900', 'dark:text-white');
                tabEditor.classList.remove('bg-white', 'dark:bg-gray-900', 'text-gray-500', 'dark:text-gray-400');
                tabPreview.classList.remove('bg-gray-100', 'dark:bg-gray-800', 'text-gray-900', 'dark:text-white');
                tabPreview.classList.add('bg-white', 'dark:bg-gray-900', 'text-gray-500', 'dark:text-gray-400');

                // Restore editor scroll position and cursor position
                setTimeout(() => {
                    // Restore editor content scroll position
                    tabEditorContent.scrollTop = editorScrollTop;
                    
                    const markdownInput = document.getElementById('markdown-input');
                    if (markdownInput) {
                        // Restore markdown input scroll position and cursor position
                        if (typeof markdownInputScrollTop !== 'undefined') {
                            markdownInput.scrollTop = markdownInputScrollTop;
                        }
                        if (typeof savedCursorPosition !== 'undefined') {
                            markdownInput.selectionStart = savedCursorPosition;
                            markdownInput.selectionEnd = savedCursorPosition;
                        }
                        
                        // Focus on markdown input only for mobile or if user was previously editing
                        if (window.innerWidth <= 768 || typeof savedCursorPosition !== 'undefined') {
                            markdownInput.focus();
                        }
                    }
                }, 50);
            });

            tabPreview.addEventListener('click', () => {
                // Save editor scroll position and markdown input state
                editorScrollTop = tabEditorContent.scrollTop;
                
                const markdownInput = document.getElementById('markdown-input');
                if (markdownInput) {
                    // Save cursor position and scroll position
                    savedCursorPosition = markdownInput.selectionStart;
                    markdownInputScrollTop = markdownInput.scrollTop;
                }

                tabPreviewContent.classList.remove('hidden');
                tabEditorContent.classList.add('hidden');
                tabPreview.classList.add('bg-gray-100', 'dark:bg-gray-800', 'text-gray-900', 'dark:text-white');
                tabPreview.classList.remove('bg-white', 'dark:bg-gray-900', 'text-gray-500', 'dark:text-gray-400');
                tabEditor.classList.remove('bg-gray-100', 'dark:bg-gray-800', 'text-gray-900', 'dark:text-white');
                tabEditor.classList.add('bg-white', 'dark:bg-gray-900', 'text-gray-500', 'dark:text-gray-400');
                
                updatePreview();
                
                // Restore preview scroll position
                setTimeout(() => {
                    const currentPreviewArea = tabPreviewContent.querySelector('#preview-area') || previewArea;
                    if (currentPreviewArea) {
                        currentPreviewArea.scrollTop = previewScrollTop;
                    }
                }, 100);
            });

            // Mobile FAB and menu functionality
            const mobileFab = document.getElementById('mobile-fab');
            const mobileMenu = document.getElementById('mobile-menu');
            const mobileMenuContent = document.getElementById('mobile-menu-content');

            mobileFab.addEventListener('click', () => {
                mobileMenu.classList.remove('hidden');
                setTimeout(() => {
                    mobileMenuContent.classList.remove('translate-y-full');
                }, 10);
            });

            mobileMenu.addEventListener('click', (e) => {
                if (e.target === mobileMenu) {
                    closeMobileMenu();
                }
            });

            const closeMobileMenu = () => {
                mobileMenuContent.classList.add('translate-y-full');
                setTimeout(() => {
                    mobileMenu.classList.add('hidden');
                }, 300);
            };

            // Mobile quick actions
            document.getElementById('mobile-bold').addEventListener('click', () => {
                wrapText('**', '**', '太字');
                closeMobileMenu();
                focusMarkdownInput();
            });

            document.getElementById('mobile-italic').addEventListener('click', () => {
                wrapText('*', '*', '斜体');
                closeMobileMenu();
                focusMarkdownInput();
            });

            document.getElementById('mobile-h2').addEventListener('click', () => {
                insertMarkdown('## ', '見出し2');
                closeMobileMenu();
                focusMarkdownInput();
            });

            document.getElementById('mobile-link').addEventListener('click', () => {
                insertLink();
                closeMobileMenu();
                focusMarkdownInput();
            });

            document.getElementById('mobile-save').addEventListener('click', () => {
                saveContent();
                showNotification('保存しました！', 'success');
                closeMobileMenu();
            });

            document.getElementById('mobile-copy').addEventListener('click', () => {
                copyMarkdown();
                closeMobileMenu();
            });

            const focusMarkdownInput = () => {
                setTimeout(() => {
                    const markdownInput = document.getElementById('markdown-input');
                    if (markdownInput) {
                        markdownInput.focus();
                        // Restore cursor position if available
                        if (typeof savedCursorPosition !== 'undefined') {
                            markdownInput.selectionStart = savedCursorPosition;
                            markdownInput.selectionEnd = savedCursorPosition;
                        }
                        // Restore scroll position if available
                        if (typeof markdownInputScrollTop !== 'undefined') {
                            markdownInput.scrollTop = markdownInputScrollTop;
                        }
                    }
                }, 100);
            };

            // Enhanced touch support for mobile
            const addTouchSupport = () => {
                // Add touch feedback to buttons
                document.querySelectorAll('.blog-btn, .tab-button').forEach(button => {
                    button.addEventListener('touchstart', function() {
                        this.style.transform = 'scale(0.95)';
                    });
                    
                    button.addEventListener('touchend', function() {
                        this.style.transform = '';
                    });
                    
                    button.addEventListener('touchcancel', function() {
                        this.style.transform = '';
                    });
                });

                // Prevent zoom on input focus for mobile
                if (window.innerWidth <= 768) {
                    const inputs = document.querySelectorAll('input, textarea');
                    inputs.forEach(input => {
                        input.addEventListener('focus', () => {
                            document.querySelector('meta[name="viewport"]').setAttribute('content', 
                                'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
                        });
                        
                        input.addEventListener('blur', () => {
                            document.querySelector('meta[name="viewport"]').setAttribute('content', 
                                'width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes');
                        });
                    });
                }
            };

            // Initialize touch support
            addTouchSupport();

            // Handle orientation change
            window.addEventListener('orientationchange', () => {
                setTimeout(() => {
                    updatePreview();
                    addTouchSupport();
                }, 500);
            });

            // Auto-hide mobile FAB when scrolling
            let lastScrollTop = 0;
            window.addEventListener('scroll', () => {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                if (scrollTop > lastScrollTop && scrollTop > 100) {
                    // Scrolling down
                    mobileFab.style.transform = 'translateY(100px)';
                } else {
                    // Scrolling up
                    mobileFab.style.transform = 'translateY(0)';
                }
                lastScrollTop = scrollTop;
            });

            // Initialize with tab view for mobile
            if (window.innerWidth <= 768) {
                switchToTabView();
            }

            // Scroll position storage for better UX
            let editorScrollTop = 0;
            let previewScrollTop = 0;
            let markdownInputScrollTop = 0;
            let savedCursorPosition = 0;

            // Additional event listeners to track markdown input state changes
            markdownInput.addEventListener('scroll', () => {
                markdownInputScrollTop = markdownInput.scrollTop;
            });

            // Use input event to track cursor position changes more efficiently
            markdownInput.addEventListener('input', () => {
                savedCursorPosition = markdownInput.selectionStart;
            });

            // Track cursor position on focus, click and keyup
            markdownInput.addEventListener('focus', () => {
                savedCursorPosition = markdownInput.selectionStart;
            });

            markdownInput.addEventListener('click', () => {
                savedCursorPosition = markdownInput.selectionStart;
            });

            markdownInput.addEventListener('keyup', () => {
                savedCursorPosition = markdownInput.selectionStart;
            });

            loadContent();
        });
    </script>
</body>
</html>
